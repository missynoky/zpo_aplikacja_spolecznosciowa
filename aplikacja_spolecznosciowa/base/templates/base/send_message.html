{% extends 'main.html' %}

{% block content %}
    <div class="send-message-wrapper">
        <div class="send-message-container">
            <h3>üì® Wy≈õlij nowƒÖ wiadomo≈õƒá</h3>
            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <p class="{% if message.tags %}{{ message.tags }}{% endif %}">{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <label for="receiver">Wybierz u≈ºytkownika:</label>
                <select name="user_id" required>
                    {% for user in users %}
                        <option value="{{ user.id }}">@{{ user.username }}</option>
                    {% endfor %}
                </select>

                <div class="voice-recorder">
                    <button type="button" id="startRecord">üé§ Rozpocznij nagrywanie</button>
                    <button type="button" id="stopRecord" disabled>‚èπ Zatrzymaj</button>
                    <audio id="audioPreview" controls style="display: none;"></audio>
                    <input type="file" name="audio_file" id="audioFile" accept="audio/*" hidden>
                </div>

                <textarea name="message" placeholder="Lub wpisz tekstowƒÖ wiadomo≈õƒá..."></textarea>
                <button type="submit">Wy≈õlij</button>
            </form>
        </div>
    </div>

<script>
let mediaRecorder;
let audioChunks = [];

document.getElementById('startRecord').addEventListener('click', async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = (e) => {
        audioChunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const audioUrl = URL.createObjectURL(audioBlob);

        const audioPreview = document.getElementById('audioPreview');
        audioPreview.src = audioUrl;
        audioPreview.style.display = 'block';

        const fileInput = document.getElementById('audioFile');
        const file = new File([audioBlob], 'recording.wav', { type: 'audio/wav' });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;

        audioChunks = [];
    };

    mediaRecorder.start();
    document.getElementById('startRecord').disabled = true;
    document.getElementById('stopRecord').disabled = false;
});

document.getElementById('stopRecord').addEventListener('click', () => {
    mediaRecorder.stop();
    document.getElementById('startRecord').disabled = false;
    document.getElementById('stopRecord').disabled = true;
});
</script>
{% endblock %}